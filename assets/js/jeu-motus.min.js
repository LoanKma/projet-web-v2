let CURRENT_USER_ID = "guest";
async function initSession() {
  try {
    const response = await fetch("api/get_user.php");
    const data = await response.json();
    CURRENT_USER_ID = data.userId;
  } catch (e) {
    CURRENT_USER_ID = "guest";
  }
}
if (typeof showPopup !== "function") {
  (function () {
    const s = document.createElement("script");
    s.src = "assets/js/main.js";
    s.async = !0;
    document.head.appendChild(s);
  })();
}
const MOTUS_LEVELS = {
  1: {
    word: "CHATS",
    difficulty: "easy",
    theme: "Animaux",
    hint: "Petit f√©lin domestique (pluriel)",
  },
  2: {
    word: "FLEUR",
    difficulty: "easy",
    theme: "Nature",
    hint: "Partie color√©e d'une plante",
  },
  3: {
    word: "ROUGE",
    difficulty: "easy",
    theme: "Couleurs",
    hint: "La couleur du sang",
  },
  4: {
    word: "SPORT",
    difficulty: "easy",
    theme: "Activit√©s",
    hint: "Activit√© physique",
  },
  5: { word: "TROIS", difficulty: "easy", theme: "Nombres", hint: "1, 2, ..." },
  6: {
    word: "VILLE",
    difficulty: "easy",
    theme: "G√©ographie",
    hint: "Lieu d'habitation urbain",
  },
  7: {
    word: "TIGRES",
    difficulty: "medium",
    theme: "Animaux",
    hint: "Grands f√©lins ray√©s",
  },
  8: {
    word: "JARDIN",
    difficulty: "medium",
    theme: "Nature",
    hint: "Espace vert avec des fleurs",
  },
  9: {
    word: "CLAVIER",
    difficulty: "medium",
    theme: "Technologie",
    hint: "P√©riph√©rique pour taper",
  },
  10: {
    word: "CINEMA",
    difficulty: "medium",
    theme: "Culture",
    hint: "Lieu pour voir des films",
  },
  11: {
    word: "BASKET",
    difficulty: "medium",
    theme: "Sports",
    hint: "Sport avec un ballon orange",
  },
  12: {
    word: "MUSIQUE",
    difficulty: "medium",
    theme: "Arts",
    hint: "Art des sons",
  },
  13: {
    word: "KANGOUROU",
    difficulty: "hard",
    theme: "Animaux",
    hint: "Animal sauteur d'Australie",
  },
  14: {
    word: "PHILOSOPHIE",
    difficulty: "hard",
    theme: "Sciences",
    hint: "R√©flexion sur l'existence",
  },
  15: {
    word: "ARCHITECTURE",
    difficulty: "hard",
    theme: "Arts",
    hint: "Art de concevoir des b√¢timents",
  },
  16: {
    word: "REVOLUTION",
    difficulty: "hard",
    theme: "Histoire",
    hint: "Changement radical",
  },
  17: {
    word: "DEMOCRATIE",
    difficulty: "hard",
    theme: "Politique",
    hint: "Pouvoir du peuple",
  },
  18: {
    word: "ASTROPHYSIQUE",
    difficulty: "hard",
    theme: "Sciences",
    hint: "√âtude des astres",
  },
};
const MAX_ATTEMPTS = 6;
let WORD_LENGTH = 5;
let TARGET_WORD = "";
let currentLevelId = 1;
let currentRow = 0;
let currentCol = 0;
let gameOver = !1;
let startTime = Date.now();
let timerInterval;
let attempts = [];
function loadLevel() {
  const savedLevel = localStorage.getItem("currentMotusLevel");
  if (savedLevel) {
    try {
      const { levelId } = JSON.parse(savedLevel);
      const levelData = MOTUS_LEVELS[levelId];
      if (levelData) {
        TARGET_WORD = levelData.word;
        WORD_LENGTH = TARGET_WORD.length;
        currentLevelId = levelId;
        return;
      }
    } catch (e) {
      console.error("Erreur chargement niveau:", e);
    }
  }
  const defaultLevel = MOTUS_LEVELS[1];
  TARGET_WORD = defaultLevel.word;
  WORD_LENGTH = TARGET_WORD.length;
  currentLevelId = 1;
  localStorage.setItem("currentMotusLevel", JSON.stringify({ levelId: 1 }));
}
function initGrid() {
  const grid = document.getElementById("motusGrid");
  grid.innerHTML = "";
  attempts = [];
  for (let row = 0; row < MAX_ATTEMPTS; row++) {
    const rowDiv = document.createElement("div");
    rowDiv.className = "grid-row";
    for (let col = 0; col < WORD_LENGTH; col++) {
      const cell = document.createElement("div");
      cell.className = "grid-cell";
      cell.id = `cell-${row}-${col}`;
      if (col === 0 && row === currentRow) {
        cell.textContent = TARGET_WORD[0];
        cell.classList.add("first-letter");
      } else if (row > currentRow) {
        cell.classList.add("disabled");
      }
      rowDiv.appendChild(cell);
    }
    grid.appendChild(rowDiv);
    attempts[row] = new Array(WORD_LENGTH).fill("");
  }
  attempts[0][0] = TARGET_WORD[0];
  currentCol = 1;
}
document.addEventListener("keydown", (e) => {
  if (gameOver) return;
  if (e.key === "Enter") {
    validateWord();
  } else if (e.key === "Backspace") {
    deleteLetter();
  } else if (/^[a-zA-Z]$/.test(e.key)) {
    addLetter(e.key.toUpperCase());
  }
});
document.querySelectorAll(".key").forEach((key) => {
  key.addEventListener("click", () => {
    if (gameOver) return;
    const letter = key.getAttribute("data-key");
    if (letter) {
      addLetter(letter);
    }
  });
});
document.getElementById("validateBtn").addEventListener("click", validateWord);
document.getElementById("deleteBtn").addEventListener("click", deleteLetter);
function addLetter(letter) {
  if (currentCol < WORD_LENGTH) {
    const cell = document.getElementById(`cell-${currentRow}-${currentCol}`);
    cell.textContent = letter;
    cell.classList.add("active");
    attempts[currentRow][currentCol] = letter;
    currentCol++;
    while (currentCol < WORD_LENGTH && attempts[currentRow][currentCol]) {
      currentCol++;
    }
  }
}
function deleteLetter() {
  if (currentCol > 1) {
    currentCol--;
    while (currentCol > 1 && !attempts[currentRow][currentCol]) {
      currentCol--;
    }
    const cell = document.getElementById(`cell-${currentRow}-${currentCol}`);
    cell.textContent = "";
    cell.classList.remove("active");
    attempts[currentRow][currentCol] = "";
  }
}
function validateWord() {
  if (currentCol !== WORD_LENGTH) {
    showPopup("Mot incomplet !", "Erreur", 1000);
    return;
  }
  const guess = attempts[currentRow].join("");
  if (typeof DICTIONNAIRE !== "undefined" && !isWordInDictionary(guess)) {
    shakeRow(currentRow);
    showPopup(`Le mot "${guess}" n'est pas dans le dictionnaire.`, "Inconnu");
    return;
  }
  for (let i = 0; i < WORD_LENGTH; i++) {
    const cell = document.getElementById(`cell-${currentRow}-${i}`);
    const letter = guess[i];
    const key = document.querySelector(`[data-key="${letter}"]`);
    cell.classList.remove("active");
    if (letter === TARGET_WORD[i]) {
      cell.classList.add("correct");
      if (key) key.classList.add("correct");
    } else if (TARGET_WORD.includes(letter)) {
      cell.classList.add("present");
      if (key && !key.classList.contains("correct")) {
        key.classList.add("present");
      }
    } else {
      cell.classList.add("absent");
      if (key) key.classList.add("absent");
    }
  }
  if (guess === TARGET_WORD) {
    gameOver = !0;
    clearInterval(timerInterval);
    const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
    saveProgress(currentLevelId, elapsedTime);
    setTimeout(() => {
      const nextLevelId = currentLevelId + 1;
      if (MOTUS_LEVELS[nextLevelId]) {
        showSuccessPopup(elapsedTime, nextLevelId);
      } else {
        showCompletionPopup();
      }
    }, 500);
    return;
  }
  currentRow++;
  currentCol = 1;
  if (currentRow < MAX_ATTEMPTS) {
    const firstCell = document.getElementById(`cell-${currentRow}-0`);
    firstCell.textContent = TARGET_WORD[0];
    firstCell.classList.add("first-letter");
    firstCell.classList.remove("disabled");
    attempts[currentRow][0] = TARGET_WORD[0];
    for (let i = 1; i < WORD_LENGTH; i++) {
      const cell = document.getElementById(`cell-${currentRow}-${i}`);
      cell.classList.remove("disabled");
    }
  } else {
    gameOver = !0;
    clearInterval(timerInterval);
    setTimeout(() => {
      showFailurePopup();
    }, 500);
  }
  updateAttempts();
}
function saveProgress(levelId, time) {
  const storageKey = `motusProgress_${CURRENT_USER_ID}`;
  const progress = JSON.parse(localStorage.getItem(storageKey) || "{}");
  if (!progress[levelId] || time < progress[levelId].bestTime) {
    progress[levelId] = {
      completed: !0,
      bestTime: time,
      attempts: currentRow + 1,
      completedAt: Date.now(),
    };
  }
  localStorage.setItem(storageKey, JSON.stringify(progress));
}
function updateAttempts() {
  document.getElementById("attempts").textContent = `${currentRow}/6`;
  if (document.getElementById("usedAttempts")) {
    document.getElementById("usedAttempts").textContent = `${currentRow}/6`;
  }
}
function startTimer() {
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60)
      .toString()
      .padStart(2, "0");
    const seconds = (elapsed % 60).toString().padStart(2, "0");
    document.getElementById("timer").textContent = `${minutes}:${seconds}`;
    if (document.getElementById("elapsedTime")) {
      document.getElementById("elapsedTime").textContent =
        `${minutes}:${seconds}`;
    }
  }, 1000);
}
document.getElementById("hintBtn").addEventListener("click", () => {
  if (gameOver) {
    return;
  }
  const emptyPositions = [];
  for (let i = 1; i < WORD_LENGTH; i++) {
    if (!attempts[currentRow][i]) {
      emptyPositions.push(i);
    }
  }
  if (emptyPositions.length > 0) {
    const randomPos =
      emptyPositions[Math.floor(Math.random() * emptyPositions.length)];
    const cell = document.getElementById(`cell-${currentRow}-${randomPos}`);
    const letter = TARGET_WORD[randomPos];
    cell.textContent = letter;
    cell.classList.add("active");
    cell.classList.add("hint-letter");
    attempts[currentRow][randomPos] = letter;
    currentCol = 1;
    while (currentCol < WORD_LENGTH && attempts[currentRow][currentCol]) {
      currentCol++;
    }
    const levelData = MOTUS_LEVELS[currentLevelId];
    const hintMessage = `Indice : ${
      levelData.hint
    }\nLa lettre "${letter}" a √©t√© r√©v√©l√©e en position ${randomPos + 1} !`;
    showPopup(hintMessage, "Indice");
  } else {
    showPopup("Toutes les lettres sont d√©j√† remplies !", "Info");
  }
});
document.getElementById("restartBtn").addEventListener("click", () => {
  const restartAction = () => {
    currentRow = 0;
    currentCol = 1;
    gameOver = !1;
    startTime = Date.now();
    attempts = [];
    clearInterval(timerInterval);
    document.querySelectorAll(".key").forEach((key) => {
      key.classList.remove("correct", "present", "absent");
    });
    initGrid();
    updateAttempts();
    startTimer();
  };
  const msg = "Voulez-vous vraiment recommencer ce niveau ?";
  if (typeof showConfirmPopup === "function") {
    showConfirmPopup(msg, restartAction);
  } else if (confirm(msg)) {
    restartAction();
  }
});
function loadLevelInfo() {
  const levelData = MOTUS_LEVELS[currentLevelId];
  if (levelData) {
    const difficultyText =
      levelData.difficulty === "easy"
        ? "Facile"
        : levelData.difficulty === "medium"
          ? "Moyen"
          : "Difficile";
    const levelNumber =
      currentLevelId <= 6
        ? currentLevelId
        : currentLevelId <= 12
          ? currentLevelId - 6
          : currentLevelId - 12;
    document.getElementById("levelTitle").textContent =
      `${difficultyText} - Niveau ${levelNumber} : ${levelData.theme}`;
    const badge = document.querySelector(".level-badge");
    if (badge) {
      badge.classList.remove("easy", "medium", "hard");
      badge.classList.add(levelData.difficulty);
      badge.style.background =
        levelData.difficulty === "easy"
          ? "rgba(34, 197, 94, 0.2)"
          : levelData.difficulty === "medium"
            ? "rgba(251, 191, 36, 0.2)"
            : "rgba(239, 68, 68, 0.2)";
      badge.style.borderColor =
        levelData.difficulty === "easy"
          ? "#22c55e"
          : levelData.difficulty === "medium"
            ? "#fbbf24"
            : "#ef4444";
      badge.style.color =
        levelData.difficulty === "easy"
          ? "#22c55e"
          : levelData.difficulty === "medium"
            ? "#fbbf24"
            : "#ef4444";
    }
  }
}
function showSuccessPopup(elapsedTime, nextLevelId) {
  const minutes = Math.floor(elapsedTime / 60);
  const seconds = elapsedTime % 60;
  const popup = document.createElement("div");
  popup.className = "popup-overlay";
  popup.innerHTML = `
        <div class="popup-content success">
            <div class="popup-icon">üéâ</div>
            <h2>Bravo !</h2>
            <p>Vous avez trouv√© le mot <strong>${TARGET_WORD}</strong></p>
            <div class="popup-stats">
                <div class="stat">
                    <i class="fa-solid fa-clock"></i>
                    <span>${minutes}m ${seconds}s</span>
                </div>
                <div class="stat">
                    <i class="fa-solid fa-list-check"></i>
                    <span>${currentRow + 1}/6 tentatives</span>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="popup-btn primary" onclick="goToNextLevel(${nextLevelId})">
                    <i class="fa-solid fa-arrow-right"></i>
                    Niveau suivant
                </button>
                <button class="popup-btn secondary" onclick="closePopup()">
                    <i class="fa-solid fa-home"></i>
                    Retour aux niveaux
                </button>
            </div>
        </div>
    `;
  document.body.appendChild(popup);
  setTimeout(() => popup.classList.add("show"), 10);
}
function showFailurePopup() {
  const popup = document.createElement("div");
  popup.className = "popup-overlay";
  popup.innerHTML = `
        <div class="popup-content failure">
            <div class="popup-icon">üò¢</div>
            <h2>Perdu !</h2>
            <p>Le mot √©tait : <strong>${TARGET_WORD}</strong></p>
            <div class="popup-buttons">
                <button class="popup-btn primary" onclick="restartLevel()">
                    <i class="fa-solid fa-rotate-right"></i>
                    Recommencer
                </button>
                <button class="popup-btn secondary" onclick="closePopup()">
                    <i class="fa-solid fa-home"></i>
                    Retour aux niveaux
                </button>
            </div>
        </div>
    `;
  document.body.appendChild(popup);
  setTimeout(() => popup.classList.add("show"), 10);
}
function showCompletionPopup() {
  const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
  const minutes = Math.floor(elapsedTime / 60);
  const seconds = elapsedTime % 60;
  const difficulty = MOTUS_LEVELS[currentLevelId].difficulty;
  const score = calculateScore(difficulty, elapsedTime, currentRow + 1, !0);
  const scoreData = saveScore(
    "motus",
    currentLevelId,
    difficulty,
    score,
    elapsedTime,
  );
  const popup = document.createElement("div");
  popup.className = "popup-overlay";
  popup.innerHTML = `
        <div class="popup-content completion">
            <div class="popup-icon">üèÜ</div>
            <h2>Incroyable !</h2>
            <p>Vous avez termin√© tous les niveaux Motus !</p>
            <p>Vous avez trouv√© le mot <strong>${TARGET_WORD}</strong></p>
            
            ${showScoreInPopup(
              scoreData.currentScore,
              scoreData.totalPoints,
              scoreData.isNewRecord,
            )}
            
            <div class="popup-stats">
                <div class="stat">
                    <i class="fa-solid fa-clock"></i>
                    <span>${minutes}m ${seconds}s</span>
                </div>
                <div class="stat">
                    <i class="fa-solid fa-list-check"></i>
                    <span>${currentRow + 1}/6 tentatives</span>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="popup-btn primary" onclick="closePopup()">
                    <i class="fa-solid fa-home"></i>
                    Retour aux niveaux
                </button>
            </div>
        </div>
    `;
  document.body.appendChild(popup);
  setTimeout(() => popup.classList.add("show"), 10);
}
function closePopup() {
  const popup = document.querySelector(".popup-overlay");
  if (popup) {
    popup.classList.remove("show");
    setTimeout(() => {
      popup.remove();
      window.location.href = "motus.html";
    }, 300);
  }
}
function goToNextLevel(nextLevelId) {
  localStorage.setItem(
    "currentMotusLevel",
    JSON.stringify({ levelId: nextLevelId }),
  );
  location.reload();
}
function restartLevel() {
  const popup = document.querySelector(".popup-overlay");
  if (popup) {
    popup.classList.remove("show");
    setTimeout(() => {
      popup.remove();
      currentRow = 0;
      currentCol = 1;
      gameOver = !1;
      startTime = Date.now();
      attempts = [];
      clearInterval(timerInterval);
      document.querySelectorAll(".key").forEach((key) => {
        key.classList.remove("correct", "present", "absent");
      });
      initGrid();
      updateAttempts();
      startTimer();
    }, 300);
  }
}
document.addEventListener("DOMContentLoaded", async () => {
  await initSession();
  loadLevel();
  initGrid();
  startTimer();
  loadLevelInfo();
  updateAttempts();
});
function calculateScore(difficulty, timeSeconds, attempts, completed) {
  if (!completed) return 0;
  const basePoints = { easy: 100, medium: 200, hard: 300 };
  let score = basePoints[difficulty] || 100;
  const timeBonus = Math.max(0, 100 - Math.floor(timeSeconds / 3));
  score += timeBonus;
  if (attempts > 0) {
    const attemptsBonus = Math.max(0, (7 - attempts) * 20);
    score += attemptsBonus;
  }
  return Math.round(score);
}
function saveScore(gameType, levelId, difficulty, score, timeSeconds) {
  const storageKey = `gameScores_${CURRENT_USER_ID}`;
  const allScores = JSON.parse(localStorage.getItem(storageKey) || "{}");
  if (!allScores[gameType]) {
    allScores[gameType] = {
      totalPoints: 0,
      gamesPlayed: 0,
      gamesWon: 0,
      bestScores: {},
    };
  }
  const gameScores = allScores[gameType];
  gameScores.totalPoints += score;
  gameScores.gamesPlayed++;
  gameScores.gamesWon++;
  const levelKey = `${difficulty}_${levelId}`;
  if (
    !gameScores.bestScores[levelKey] ||
    score > gameScores.bestScores[levelKey].score
  ) {
    gameScores.bestScores[levelKey] = {
      score: score,
      time: timeSeconds,
      date: new Date().toISOString(),
    };
  }
  localStorage.setItem(storageKey, JSON.stringify(allScores));
  envoyerScoreBDD(gameType, levelId, difficulty, score, timeSeconds);
  return {
    currentScore: score,
    totalPoints: gameScores.totalPoints,
    gamesWon: gameScores.gamesWon,
    isNewRecord:
      !gameScores.bestScores[levelKey] ||
      score === gameScores.bestScores[levelKey].score,
  };
}
async function envoyerScoreBDD(jeu, niveau, difficulte, score, temps) {
  try {
    await fetch("api/save_score.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jeu, niveau, difficulte, score, temps }),
    });
  } catch (e) {
    console.error("Erreur lors de l'envoi du score √† la BDD :", e);
  }
}
function showScoreInPopup(score, totalPoints, isNewRecord) {
  return `
        <div class="score-display">
            <div class="score-title">Score de la partie</div>
            <div class="score-main">${score} points</div>
            ${
              isNewRecord
                ? '<div class="new-record">üèÜ Nouveau record !</div>'
                : ""
            }
            <div class="score-total">Total : ${totalPoints} points</div>
        </div>
    `;
}
function showSuccessPopup(elapsedTime, nextLevelId) {
  const minutes = Math.floor(elapsedTime / 60);
  const seconds = elapsedTime % 60;
  const difficulty = MOTUS_LEVELS[currentLevelId].difficulty;
  const score = calculateScore(difficulty, elapsedTime, currentRow + 1, !0);
  const scoreData = saveScore(
    "motus",
    currentLevelId,
    difficulty,
    score,
    elapsedTime,
  );
  const popup = document.createElement("div");
  popup.className = "popup-overlay";
  popup.innerHTML = `
        <div class="popup-content success">
            <div class="popup-icon">üéâ</div>
            <h2>Bravo !</h2>
            <p>Vous avez trouv√© le mot <strong>${TARGET_WORD}</strong></p>
            
            ${showScoreInPopup(
              scoreData.currentScore,
              scoreData.totalPoints,
              scoreData.isNewRecord,
            )}
            
            <div class="popup-stats">
                <div class="stat">
                    <i class="fa-solid fa-clock"></i>
                    <span>${minutes}m ${seconds}s</span>
                </div>
                <div class="stat">
                    <i class="fa-solid fa-list-check"></i>
                    <span>${currentRow + 1}/6 tentatives</span>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="popup-btn primary" onclick="goToNextLevel(${nextLevelId})">
                    <i class="fa-solid fa-arrow-right"></i>
                    Niveau suivant
                </button>
                <button class="popup-btn secondary" onclick="closePopup()">
                    <i class="fa-solid fa-home"></i>
                    Retour aux niveaux
                </button>
            </div>
        </div>
    `;
  document.body.appendChild(popup);
  setTimeout(() => popup.classList.add("show"), 10);
}
function showSuccessPopupWordSearch(elapsedTime, nextLevelId) {
  const minutes = Math.floor(elapsedTime / 60);
  const seconds = elapsedTime % 60;
  const difficulty = LEVELS[currentLevelId].difficulty;
  const score = calculateScore(difficulty, elapsedTime, 0, !0);
  const scoreData = saveScore(
    "mots_meles",
    currentLevelId,
    difficulty,
    score,
    elapsedTime,
  );
  const popup = document.createElement("div");
  popup.className = "popup-overlay";
  popup.innerHTML = `
        <div class="popup-content success">
            <div class="popup-icon">üéâ</div>
            <h2>F√©licitations !</h2>
            <p>Vous avez trouv√© tous les mots !</p>
            
            ${showScoreInPopup(
              scoreData.currentScore,
              scoreData.totalPoints,
              scoreData.isNewRecord,
            )}
            
            <div class="popup-stats">
                <div class="stat">
                    <i class="fa-solid fa-clock"></i>
                    <span>${minutes}m ${seconds}s</span>
                </div>
                <div class="stat">
                    <i class="fa-solid fa-font"></i>
                    <span>${WORDS.length} mots trouv√©s</span>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="popup-btn primary" onclick="goToNextLevelWordSearch(${nextLevelId})">
                    <i class="fa-solid fa-arrow-right"></i>
                    Niveau suivant
                </button>
                <button class="popup-btn secondary" onclick="closePopupWordSearch()">
                    <i class="fa-solid fa-home"></i>
                    Retour aux niveaux
                </button>
            </div>
        </div>
    `;
  document.body.appendChild(popup);
  setTimeout(() => popup.classList.add("show"), 10);
}
function getGameStats(gameType) {
  const allScores = JSON.parse(localStorage.getItem("gameScores") || "{}");
  return (
    allScores[gameType] || {
      totalPoints: 0,
      gamesPlayed: 0,
      gamesWon: 0,
      bestScores: {},
    }
  );
}
function shakeRow(row) {
  const rowDiv = document.querySelector(`.grid-row:nth-child(${row + 1})`);
  rowDiv.classList.add("shake");
  setTimeout(() => {
    rowDiv.classList.remove("shake");
  }, 500);
}
